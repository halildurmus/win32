"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["4911"],{43941(e,n,r){r.r(n),r.d(n,{metadata:()=>t,default:()=>h,frontMatter:()=>l,contentTitle:()=>a,toc:()=>c,assets:()=>o});var t=JSON.parse('{"id":"core/memory-allocation","title":"Memory Allocation","description":"Dart is a garbage-collected language. When you create Dart objects \u2014 such as","source":"@site/docs/core/memory-allocation.md","sourceDirName":"core","slug":"/core/memory-allocation","permalink":"/docs/core/memory-allocation","draft":false,"unlisted":false,"editUrl":"https://github.com/halildurmus/win32/tree/main/website/docs/core/memory-allocation.md","tags":[],"version":"current","lastUpdatedBy":"Halil Durmus","lastUpdatedAt":1772220481000,"frontMatter":{"title":"Memory Allocation"},"sidebar":"mainSidebar","previous":{"title":"Functions","permalink":"/docs/core/functions"},"next":{"title":"Memory Management Patterns","permalink":"/docs/core/memory-management-patterns"}}'),i=r(74848),s=r(28453);let l={title:"Memory Allocation"},a,o={},c=[{value:"When Native Memory Is Required",id:"when-native-memory-is-required",level:2},{value:"Allocating Native Memory",id:"allocating-native-memory",level:2},{value:"Freeing Native Memory",id:"freeing-native-memory",level:2},{value:"Ownership Rules",id:"ownership-rules",level:2}];function d(e){let n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Dart is a ",(0,i.jsx)(n.strong,{children:"garbage-collected"})," language. When you create Dart objects \u2014 such as\nstrings or class instances \u2014 the Dart runtime is responsible for ",(0,i.jsx)(n.strong,{children:"allocating"}),"\nmemory and ",(0,i.jsx)(n.strong,{children:"reclaiming"})," it when those objects are no longer ",(0,i.jsx)(n.strong,{children:"reachable"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["This model does ",(0,i.jsx)(n.strong,{children:"not"})," extend across the FFI boundary."]}),"\n",(0,i.jsxs)(n.p,{children:["When calling Win32 APIs through ",(0,i.jsx)(n.strong,{children:"FFI"}),", you are responsible for the\n",(0,i.jsx)(n.strong,{children:"lifetime"})," of any native memory you allocate or receive from Windows.\nUnderstanding who ",(0,i.jsx)(n.em,{children:"owns"})," a block of memory \u2014 and when it must be released \u2014 is\nessential for writing correct, leak-free interop code."]}),"\n",(0,i.jsx)(n.h2,{id:"when-native-memory-is-required",children:"When Native Memory Is Required"}),"\n",(0,i.jsxs)(n.p,{children:["Only primitive values (such as integers) can be passed directly across the FFI\nboundary. All other data \u2014 such as ",(0,i.jsx)(n.strong,{children:"strings"}),", ",(0,i.jsx)(n.strong,{children:"structs"}),", and ",(0,i.jsx)(n.strong,{children:"buffers"}),"\n\u2014 must reside in ",(0,i.jsx)(n.strong,{children:"native memory"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"As a result, FFI code typically follows this pattern:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Allocate"})," native memory explicitly"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Pass"})," pointers to that memory into Win32 APIs"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Release"})," the memory when it is no longer needed"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Failing to release native memory will eventually ",(0,i.jsx)(n.strong,{children:"exhaust the native heap"}),"\nand destabilize your application."]}),"\n",(0,i.jsx)(n.h2,{id:"allocating-native-memory",children:"Allocating Native Memory"}),"\n",(0,i.jsxs)(n.p,{children:["Native memory is typically allocated using the ",(0,i.jsx)(n.a,{href:"https://pub.dev/documentation/ffi/latest/ffi/calloc-constant.html",children:(0,i.jsx)(n.code,{children:"calloc()"})})," allocator\nfrom ",(0,i.jsx)(n.a,{href:"https://pub.dev/packages/ffi",children:(0,i.jsx)(n.code,{children:"package:ffi"})}),"."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://pub.dev/packages/ffi_leak_tracker",children:(0,i.jsx)(n.code,{children:"package:ffi_leak_tracker"})})," provides allocators such\nas ",(0,i.jsx)(n.a,{href:"https://pub.dev/documentation/ffi_leak_tracker/latest/ffi_leak_tracker/adaptiveCalloc-constant.html",children:(0,i.jsx)(n.code,{children:"adaptiveCalloc()"})}),", which behave like ",(0,i.jsx)(n.code,{children:"calloc()"})," but\nalso participate in optional ",(0,i.jsx)(n.a,{href:"/docs/advanced/leak-tracking",children:(0,i.jsx)(n.strong,{children:"leak tracking"})}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"void main() {\n  // highlight-next-line\n  final pBuffer = adaptiveCalloc<Uint8>(256);\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This allocates ",(0,i.jsx)(n.strong,{children:"256 bytes"})," of ",(0,i.jsx)(n.em,{children:"zero-initialized"})," memory and returns a\n",(0,i.jsx)(n.code,{children:"Pointer<Uint8>"}),". The memory can be accessed using indexed syntax:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"for (var i = 0; i < 256; i++) {\n  // highlight-next-line\n  pBuffer[i] = i % 8;\n}\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"danger",children:(0,i.jsxs)(n.p,{children:["Only ",(0,i.jsx)(n.strong,{children:"access memory"})," that you have explicitly ",(0,i.jsx)(n.strong,{children:"allocated"}),". Reading or\nwriting outside the bounds of an allocation can result in\n",(0,i.jsx)(n.strong,{children:"undefined behavior"}),", including ",(0,i.jsx)(n.strong,{children:"crashes"})," and ",(0,i.jsx)(n.strong,{children:"data corruption"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"freeing-native-memory",children:"Freeing Native Memory"}),"\n",(0,i.jsx)(n.p,{children:"Allocated native memory must be released explicitly when it is no longer needed."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://api.dart.dev/dart-ffi/",children:(0,i.jsx)(n.code,{children:"dart:ffi"})})," library exposes ",(0,i.jsx)(n.a,{href:"https://api.dart.dev/dart-ffi/Allocator/free.html",children:(0,i.jsx)(n.code,{children:"calloc.free()"})}),", but\n",(0,i.jsx)(n.code,{children:"package:win32"})," provides a top-level convenience function ",(0,i.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/free.html",children:(0,i.jsx)(n.code,{children:"free()"})}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"free(pBuffer);\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.p,{children:["When a Dart program ",(0,i.jsx)(n.em,{children:"exits"}),", Windows will reclaim all remaining native memory.\nLong-running applications must ",(0,i.jsx)(n.strong,{children:"not"})," rely on this behavior."]}),(0,i.jsxs)(n.p,{children:["Native memory is ",(0,i.jsx)(n.strong,{children:"not"})," garbage-collected. Failing to free allocations results\nin memory leaks that accumulate over time."]})]}),"\n",(0,i.jsx)(n.h2,{id:"ownership-rules",children:"Ownership Rules"}),"\n",(0,i.jsx)(n.p,{children:"Every block of native memory has a single, well-defined owner."}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"If you allocate the memory, you must free it."})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"In practice:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Source of memory"}),(0,i.jsx)(n.th,{children:"Owner"}),(0,i.jsx)(n.th,{children:"How to release"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"calloc()"}),", ",(0,i.jsx)(n.code,{children:"malloc()"}),", ",(0,i.jsx)(n.code,{children:"adaptiveCalloc()"})," etc."]}),(0,i.jsx)(n.td,{children:"You"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"free(ptr)"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Pointer returned by a Win32 API"}),(0,i.jsx)(n.td,{children:"Varies"}),(0,i.jsx)(n.td,{children:"API-specific"})]})]})]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Always consult the Windows API documentation to determine ownership of\nreturned pointers and the correct way to release them."}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453(e,n,r){r.d(n,{R:()=>l,x:()=>a});var t=r(96540);let i={},s=t.createContext(i);function l(e){let n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);