"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["6070"],{45229(e,n,l){l.r(n),l.d(n,{metadata:()=>t,default:()=>h,frontMatter:()=>r,contentTitle:()=>s,toc:()=>o,assets:()=>c});var t=JSON.parse('{"id":"advanced/callbacks","title":"Callbacks","description":"Some Win32 APIs invoke caller-supplied functions to report progress, stream","source":"@site/docs/advanced/callbacks.md","sourceDirName":"advanced","slug":"/advanced/callbacks","permalink":"/docs/advanced/callbacks","draft":false,"unlisted":false,"editUrl":"https://github.com/halildurmus/win32/tree/main/website/docs/advanced/callbacks.md","tags":[],"version":"current","lastUpdatedBy":"Halil Durmus","lastUpdatedAt":1772220481000,"frontMatter":{"title":"Callbacks"},"sidebar":"mainSidebar","previous":{"title":"Structs","permalink":"/docs/core/structs"},"next":{"title":"COM","permalink":"/docs/advanced/com"}}'),a=l(74848),i=l(28453);let r={title:"Callbacks"},s,c={},o=[{value:"Creating Callbacks",id:"creating-callbacks",level:2},{value:"<code>NativeCallable.isolateLocal</code>",id:"nativecallableisolatelocal",level:3},{value:"<code>NativeCallable.listener</code>",id:"nativecallablelistener",level:3},{value:"<code>NativeCallable.isolateGroupBound</code> (<strong>Preview</strong>)",id:"nativecallableisolategroupbound-preview",level:3},{value:"Defining a Callback Function",id:"defining-a-callback-function",level:2},{value:"Registering a Callback",id:"registering-a-callback",level:2},{value:"Lifetime And Ownership",id:"lifetime-and-ownership",level:2},{value:"Choosing the Right Callback Mode",id:"choosing-the-right-callback-mode",level:2},{value:"Common Failure Modes",id:"common-failure-modes",level:2},{value:"Wrong Thread",id:"wrong-thread",level:3},{value:"Use-After-Close",id:"use-after-close",level:3}];function d(e){let n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components},{CommonViewSourceCode:l}=n;return l||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("CommonViewSourceCode",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["Some Win32 APIs invoke ",(0,a.jsx)(n.strong,{children:"caller-supplied functions"})," to report progress, stream\nresults, or notify events. These are ",(0,a.jsx)(n.em,{children:"not"})," Dart-style async callbacks \u2014 they are\n",(0,a.jsx)(n.strong,{children:"native calls back into Dart code"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"From Dart FFI's perspective, a Win32 callback is a function pointer that the\nnative API stores and later invokes on an arbitrary thread."}),"\n",(0,a.jsx)(n.h2,{id:"creating-callbacks",children:"Creating Callbacks"}),"\n",(0,a.jsx)(n.p,{children:"Win32 API may invoke your callback from:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"The same thread"}),"\n",(0,a.jsx)(n.li,{children:"A worker thread"}),"\n",(0,a.jsx)(n.li,{children:"A thread pool thread"}),"\n",(0,a.jsx)(n.li,{children:"A GUI thread"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Dart therefore provides multiple callback modes with different safety and\nthreading guarantees to create ",(0,a.jsx)(n.strong,{children:"native-callable"})," callbacks."]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Constructor"}),(0,a.jsx)(n.th,{style:{textAlign:"center"},children:"Callable From"}),(0,a.jsx)(n.th,{style:{textAlign:"center"},children:"Return Type"}),(0,a.jsx)(n.th,{children:"Restrictions"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.a,{href:"https://api.dart.dev/dart-ffi/NativeCallable/NativeCallable.isolateLocal.html",children:(0,a.jsx)(n.code,{children:"NativeCallable.isolateLocal"})})}),(0,a.jsx)(n.td,{style:{textAlign:"center"},children:"Same thread only"}),(0,a.jsx)(n.td,{style:{textAlign:"center"},children:"Any"}),(0,a.jsx)(n.td,{children:"Must be invoked on the creating thread"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.a,{href:"https://api.dart.dev/dart-ffi/NativeCallable/NativeCallable.listener.html",children:(0,a.jsx)(n.code,{children:"NativeCallable.listener"})})}),(0,a.jsx)(n.td,{style:{textAlign:"center"},children:"Any thread"}),(0,a.jsxs)(n.td,{style:{textAlign:"center"},children:[(0,a.jsx)(n.code,{children:"void"}),"-only"]}),(0,a.jsx)(n.td,{children:"No return values"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.a,{href:"https://api.dart.dev/dart-ffi/NativeCallable/NativeCallable.isolateGroupBound.html",children:(0,a.jsx)(n.code,{children:"NativeCallable.isolateGroupBound"})})}),(0,a.jsx)(n.td,{style:{textAlign:"center"},children:"Any thread"}),(0,a.jsx)(n.td,{style:{textAlign:"center"},children:"Any"}),(0,a.jsxs)(n.td,{children:["May only access ",(0,a.jsx)(n.strong,{children:"isolate-group-shared"})," state"]})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"nativecallableisolatelocal",children:(0,a.jsx)(n.code,{children:"NativeCallable.isolateLocal"})}),"\n",(0,a.jsxs)(n.p,{children:["Use this when the native API ",(0,a.jsx)(n.strong,{children:"guarantees"})," that the callback runs on the same\nthread that registered it."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"final callback = NativeCallable<FONTENUMPROC>.isolateLocal(\n  enumerateFonts,\n  exceptionalReturn: 0,\n);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"nativecallablelistener",children:(0,a.jsx)(n.code,{children:"NativeCallable.listener"})}),"\n",(0,a.jsx)(n.p,{children:"Use this when the callback:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["May be invoked from ",(0,a.jsx)(n.strong,{children:"any thread"})]}),"\n",(0,a.jsxs)(n.li,{children:["Returns ",(0,a.jsx)(n.code,{children:"void"})]}),"\n",(0,a.jsx)(n.li,{children:"Is used for notifications or events"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"final callback = NativeCallable<Void Function(Int32)>.listener(onEvent);\n"})}),"\n",(0,a.jsxs)(n.h3,{id:"nativecallableisolategroupbound-preview",children:[(0,a.jsx)(n.code,{children:"NativeCallable.isolateGroupBound"})," (",(0,a.jsx)(n.strong,{children:"Preview"}),")"]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["Requires ",(0,a.jsx)(n.code,{children:"--experimental-shared-data"})," flag to be passed to the Dart VM in\norder to access ",(0,a.jsx)(n.strong,{children:"isolate-group-shared"})," state."]}),"\n",(0,a.jsxs)(n.p,{children:["For example: ",(0,a.jsx)(n.code,{children:"dart --experimental-shared-data run example.dart"})]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Use this when the callback:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["May be invoked from ",(0,a.jsx)(n.strong,{children:"any thread"})]}),"\n",(0,a.jsx)(n.li,{children:"Must return a value"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"final callback = NativeCallable<FONTENUMPROC>.isolateGroupBound(\n  enumerateFonts,\n  exceptionalReturn: 0,\n);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This allows invocation from arbitrary threads, but with the restriction that the\ncallback may only access ",(0,a.jsx)(n.strong,{children:"isolate-group-shared"})," state."]}),"\n",(0,a.jsx)(n.h2,{id:"defining-a-callback-function",children:"Defining a Callback Function"}),"\n",(0,a.jsxs)(n.p,{children:["The Dart function must match the ",(0,a.jsx)(n.strong,{children:"native callback signature"})," exactly."]}),"\n",(0,a.jsxs)(n.p,{children:["For example, let's look at the ",(0,a.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/wingdi/nf-wingdi-enumfontfamiliesexw",children:(0,a.jsx)(n.code,{children:"EnumFontFamiliesEx"})}),"\nfunction, which ",(0,a.jsx)(n.strong,{children:"enumerates"})," all uniquely-named ",(0,a.jsx)(n.strong,{children:"fonts"})," in the system that\nmatch a specified set of font characteristics. ",(0,a.jsx)(n.code,{children:"EnumFontFamiliesEx"})," takes a\n",(0,a.jsx)(n.code,{children:"LOGFONT"})," struct which contains information about the fonts to enumerate."]}),"\n",(0,a.jsx)(n.p,{children:"The Dart function signature looks like this:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"int EnumFontFamiliesEx(\n  int hdc,\n  Pointer<LOGFONT> lpLogfont,\n  // highlight-next-line\n  Pointer<NativeFunction<FONTENUMPROC>> lpProc,\n  int lParam,\n  int dwFlags,\n) { ... }\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Notice the ",(0,a.jsx)(n.strong,{children:"third"})," parameter \u2014 a pointer to the callback function. This is\ncalled ",(0,a.jsx)(n.strong,{children:"once"})," for every enumerated font, and is defined as:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"typedef FONTENUMPROC =\n    Int32 Function(\n      Pointer<LOGFONT> param0,\n      Pointer<TEXTMETRIC> param1,\n      Uint32 param2,\n      IntPtr param3,\n    );\n"})}),"\n",(0,a.jsx)(n.p,{children:"Define a Dart function using Dart equivalents:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"int enumerateFonts(\n  Pointer<LOGFONT> logFont,\n  Pointer<TEXTMETRIC> _,\n  int _,\n  int _,\n) {\n  final logFontEx = logFont.cast<ENUMLOGFONTEX>();\n  print(logFontEx.ref.elfFullName);\n  return TRUE; // continue enumeration\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"registering-a-callback",children:"Registering a Callback"}),"\n",(0,a.jsxs)(n.p,{children:["Example using ",(0,a.jsx)(n.code,{children:"EnumFontFamiliesEx"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",metastring:'title="fonts.dart"',children:"int enumerateFonts(\n  Pointer<LOGFONT> logFont,\n  Pointer<TEXTMETRIC> _,\n  int _,\n  int _,\n) {\n  final logFontEx = logFont.cast<ENUMLOGFONTEX>();\n  print(logFontEx.ref.elfFullName);\n  return TRUE; // continue enumeration\n}\n\nvoid main() {\n  final hDC = GetDC(null);\n  final searchFont = adaptiveCalloc<LOGFONT>()\n    ..ref.lfCharSet = HANGUL_CHARSET;\n\n  // highlight-start\n  final callback = NativeCallable<FONTENUMPROC>.isolateLocal(\n    enumerateFonts,\n    exceptionalReturn: 0,\n  );\n  // highlight-end\n\n  // highlight-start\n  EnumFontFamiliesEx(\n    hDC,\n    searchFont,\n    callback.nativeFunction,\n    const .new(0),\n    0,\n  );\n  // highlight-end\n\n  callback.close();\n  free(searchFont);\n}\n"})}),"\n",(0,a.jsx)(l,{href:"https://github.com/halildurmus/win32/blob/main/examples/fonts.dart"}),"\n",(0,a.jsx)(n.h2,{id:"lifetime-and-ownership",children:"Lifetime And Ownership"}),"\n",(0,a.jsx)(n.p,{children:"Callbacks are native resources."}),"\n",(0,a.jsxs)(n.p,{children:["You ",(0,a.jsx)(n.strong,{children:"must"})," close them when no longer needed:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"final callback = NativeCallable<FONTENUMPROC>.isolateLocal(...);\n...\ncallback.close();\n"})}),"\n",(0,a.jsx)(n.h2,{id:"choosing-the-right-callback-mode",children:"Choosing the Right Callback Mode"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Situation"}),(0,a.jsx)(n.th,{children:"Use"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Callback runs on the registering thread"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"NativeCallable.isolateLocal"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsxs)(n.td,{children:["Callback runs on arbitrary threads, returns ",(0,a.jsx)(n.code,{children:"void"})]}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"NativeCallable.listener"})})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Callback runs on arbitrary threads, returns a value"}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"NativeCallable.isolateGroupBound"})})]})]})]}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsxs)(n.p,{children:["Prefer ",(0,a.jsx)(n.code,{children:"NativeCallable.isolateLocal"}),". Use the other two only when forced by the\nAPI's threading behavior."]})}),"\n",(0,a.jsx)(n.h2,{id:"common-failure-modes",children:"Common Failure Modes"}),"\n",(0,a.jsx)(n.h3,{id:"wrong-thread",children:"Wrong Thread"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-text",children:"Cannot invoke a native callback outside an isolate.\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Cause:"})}),"\n",(0,a.jsxs)(n.p,{children:["You used ",(0,a.jsx)(n.code,{children:"NativeCallable.isolateLocal"}),", but Win32 API invoked the callback from\nanother thread."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,a.jsxs)(n.p,{children:["Switch to ",(0,a.jsx)(n.code,{children:"NativeCallable.isolateGroupBound"})," or ",(0,a.jsx)(n.code,{children:"NativeCallable.listener"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"use-after-close",children:"Use-After-Close"}),"\n",(0,a.jsx)(n.p,{children:"Crash or access violation."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Cause:"})}),"\n",(0,a.jsx)(n.p,{children:"You closed the callback while native code still held its function pointer."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Ensure the callback ",(0,a.jsx)(n.strong,{children:"outlives"})," all native uses"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Close"})," only after the native API is done"]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453(e,n,l){l.d(n,{R:()=>r,x:()=>s});var t=l(96540);let a={},i=t.createContext(a);function r(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);