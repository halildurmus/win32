"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["8208"],{88655(e,n,t){t.r(n),t.d(n,{metadata:()=>r,default:()=>h,frontMatter:()=>l,contentTitle:()=>a,toc:()=>o,assets:()=>d});var r=JSON.parse('{"id":"core/strings","title":"Strings","description":"Win32 APIs make heavy use of strings for parameters and return values.","source":"@site/docs/core/strings.md","sourceDirName":"core","slug":"/core/strings","permalink":"/docs/core/strings","draft":false,"unlisted":false,"editUrl":"https://github.com/halildurmus/win32/tree/main/website/docs/core/strings.md","tags":[],"version":"current","lastUpdatedBy":"Halil Durmus","lastUpdatedAt":1772220481000,"frontMatter":{"title":"Strings"},"sidebar":"mainSidebar","previous":{"title":"Integer Types","permalink":"/docs/core/integer-types"},"next":{"title":"Structs","permalink":"/docs/core/structs"}}'),s=t(74848),i=t(28453);let l={title:"Strings"},a,d={},o=[{value:"Dart Strings to Native Strings",id:"dart-strings-to-native-strings",level:2},{value:"UTF-16 (PCWSTR / PWSTR)",id:"utf-16-pcwstr--pwstr",level:3},{value:"ANSI (PCSTR / PSTR)",id:"ansi-pcstr--pstr",level:3},{value:"COM Strings (BSTR)",id:"com-strings-bstr",level:3},{value:"WinRT Strings (HSTRING)",id:"winrt-strings-hstring",level:3},{value:"Native Strings to Dart Strings",id:"native-strings-to-dart-strings",level:2},{value:"Variable-Length Results",id:"variable-length-results",level:3},{value:"<code>MULTI_SZ</code> Strings",id:"multi_sz-strings",level:2}];function c(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Win32 APIs make heavy use of ",(0,s.jsx)(n.strong,{children:"strings"})," for parameters and return values."]}),"\n",(0,s.jsxs)(n.p,{children:["Unlike normal Dart strings, native strings live in ",(0,s.jsx)(n.strong,{children:"native memory"})," and follow\n",(0,s.jsx)(n.strong,{children:"explicit ownership rules"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Win32 uses multiple string formats:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"UTF-16"})," (",(0,s.jsx)(n.code,{children:"WCHAR*"}),", ",(0,s.jsx)(n.code,{children:"LPWSTR"}),", ",(0,s.jsx)(n.code,{children:"PCWSTR"}),", ",(0,s.jsx)(n.code,{children:"PWSTR"}),") \u2014 modern Win32 APIs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"ANSI"})," (",(0,s.jsx)(n.code,{children:"CHAR*"}),", ",(0,s.jsx)(n.code,{children:"LPSTR"}),", ",(0,s.jsx)(n.code,{children:"PCSTR"}),", ",(0,s.jsx)(n.code,{children:"PSTR"}),") \u2014 legacy APIs\n(code-page\u2013dependent; often UTF-8 in practice, but not guaranteed)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"BSTR"})," \u2014 COM automation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"HSTRING"})," \u2014 WinRT"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Modern Win32 APIs almost always use UTF-16 (",(0,s.jsx)(n.code,{children:"PCWSTR"})," or ",(0,s.jsx)(n.code,{children:"PWSTR"}),")."]}),"\n",(0,s.jsx)(n.h2,{id:"dart-strings-to-native-strings",children:"Dart Strings to Native Strings"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://pub.dev/packages/win32",children:(0,s.jsx)(n.code,{children:"package:win32"})})," provides APIs for converting Dart strings into\nnative representations."]}),"\n",(0,s.jsxs)(n.p,{children:["Choose the representation based on the ",(0,s.jsx)(n.strong,{children:"API signature"}),", then choose the\nallocation style based on ",(0,s.jsx)(n.strong,{children:"lifetime requirements"}),"."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Conversion Method"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PCWSTR"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringExtension/toPcwstr.html",children:(0,s.jsx)(n.code,{children:"StringExtension.toPcwstr()"})})," / ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/pcwstr.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.pcwstr()"})})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PWSTR"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringExtension/toPwstr.html",children:(0,s.jsx)(n.code,{children:"StringExtension.toPwstr()"})})," / ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/pwstr.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.pwstr()"})})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PCSTR"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringExtension/toPcstr.html",children:(0,s.jsx)(n.code,{children:"StringExtension.toPcstr()"})})," / ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/pcstr.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.pcstr()"})})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PSTR"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringExtension/toPstr.html",children:(0,s.jsx)(n.code,{children:"StringExtension.toPstr()"})})," / ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/pstr.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.pstr()"})})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BSTR"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringExtension/toBstr.html",children:(0,s.jsx)(n.code,{children:"StringExtension.toBstr()"})})," / ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/bstr.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.bstr()"})})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"HSTRING"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringExtension/toHstring.html",children:(0,s.jsx)(n.code,{children:"StringExtension.toHstring()"})})," / ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/hstring.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.hstring()"})})]})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["All of these methods allocate native memory and return lightweight\n",(0,s.jsx)(n.strong,{children:"wrapper types"})," around the underlying pointer or handle."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Allocation strategies"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Arena-based allocation"})," ties the string's lifetime to a lexical scope and\nreleases it automatically when the arena is disposed."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Manual allocation"})," returns a string whose lifetime you must manage\nexplicitly using the appropriate deallocation API."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["If you use the ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringExtension.html",children:(0,s.jsx)(n.code,{children:"StringExtension"})})," methods, you are responsible\nfor freeing the allocated memory:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"PCWSTR"})," / ",(0,s.jsx)(n.code,{children:"PWSTR"})," / ",(0,s.jsx)(n.code,{children:"PCSTR"})," / ",(0,s.jsx)(n.code,{children:"PSTR"})," -> ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/free.html",children:(0,s.jsx)(n.code,{children:"free()"})})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BSTR"})," -> ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/SysFreeString.html",children:(0,s.jsx)(n.code,{children:"SysFreeString()"})})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"HSTRING"})," -> ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/WindowsDeleteString.html",children:(0,s.jsx)(n.code,{children:"WindowsDeleteString()"})})]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["Prefer Scope-based Lifetime Management with ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/Arena-class.html",children:(0,s.jsx)(n.code,{children:"Arena"})})," to allocate native\nstrings unless you have a compelling reason to manage their lifetime manually."]})}),"\n",(0,s.jsx)(n.h3,{id:"utf-16-pcwstr--pwstr",children:"UTF-16 (PCWSTR / PWSTR)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final text = arena.pcwstr('MessageBox Demo');\n  MessageBox(null, text, null, MB_OK);\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This allocates a null-terminated UTF-16 string and returns a ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/PCWSTR-extension-type.html",children:(0,s.jsx)(n.code,{children:"PCWSTR"})}),"\nwrapper around ",(0,s.jsx)(n.code,{children:"Pointer<Utf16>"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"ansi-pcstr--pstr",children:"ANSI (PCSTR / PSTR)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final name = arena.pcstr('kernel32.dll');\n  // Use with APIs that require PCSTR\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This allocates a null-terminated string of 8-bit Windows (ANSI) characters and\nreturns a ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/PCSTR-extension-type.html",children:(0,s.jsx)(n.code,{children:"PCSTR"})})," wrapper around ",(0,s.jsx)(n.code,{children:"Pointer<Utf8>"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"com-strings-bstr",children:"COM Strings (BSTR)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final name = arena.bstr('Hello');\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This allocates a COM ",(0,s.jsx)(n.code,{children:"BSTR"})," string and returns a ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/BSTR-extension-type.html",children:(0,s.jsx)(n.code,{children:"BSTR"})})," wrapper around\n",(0,s.jsx)(n.code,{children:"Pointer<Utf16>"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"winrt-strings-hstring",children:"WinRT Strings (HSTRING)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final name = arena.hstring('Hello');\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This creates an immutable, reference-counted ",(0,s.jsx)(n.code,{children:"HSTRING"})," and returns a\n",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/HSTRING-extension-type.html",children:(0,s.jsx)(n.code,{children:"HSTRING"})})," wrapper around ",(0,s.jsx)(n.code,{children:"Pointer"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["To convert a ",(0,s.jsx)(n.code,{children:"HSTRING"})," back to a Dart string, use the\n",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/HSTRING/toDartString.html",children:(0,s.jsx)(n.code,{children:"HSTRING.toDartString()"})})," method."]}),"\n",(0,s.jsx)(n.h2,{id:"native-strings-to-dart-strings",children:"Native Strings to Dart Strings"}),"\n",(0,s.jsxs)(n.p,{children:["Many Win32 APIs write UTF-16 text into a caller-provided ",(0,s.jsx)(n.strong,{children:"buffer"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["When using an ",(0,s.jsx)(n.code,{children:"Arena"}),", allocate a UTF-16 buffer with\n",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/pwstrBuffer.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.pwstrBuffer()"})}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The following example calls the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpathw",children:(0,s.jsx)(n.code,{children:"SHGetFolderPath()"})})," API to\nretrieve the path of the ",(0,s.jsx)(n.strong,{children:"Desktop"})," folder:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"String getDesktopFolderPath() {\n  return using((arena) {\n    // highlight-next-line\n    final path = arena.pwstrBuffer(MAX_PATH);\n    SHGetFolderPath(CSIDL_DESKTOP, null, 0, path);\n    // highlight-next-line\n    return path.toDartString();\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, you can allocate the buffer using ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/wsalloc.html",children:(0,s.jsx)(n.code,{children:"wsalloc()"})}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"String getDesktopFolderPath() {\n  // highlight-next-line\n  final path = wsalloc(MAX_PATH);\n  try {\n    SHGetFolderPath(CSIDL_DESKTOP, null, 0, path);\n    // highlight-next-line\n    return path.toDartString();\n  } finally {\n    free(path);\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Unlike the previous example, here you must manually free the allocated memory\nusing ",(0,s.jsx)(n.code,{children:"free()"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The buffer is converted back to a Dart string using the\n",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/ffi/latest/ffi/Utf16Pointer/toDartString.html",children:(0,s.jsx)(n.code,{children:"Utf16Pointer.toDartString()"})})," extension method."]}),"\n",(0,s.jsxs)(t,{children:[(0,s.jsxs)("summary",{children:["Why doesn't calling ",(0,s.jsx)(n.code,{children:".toString()"})," on a ",(0,s.jsx)(n.code,{children:"Pointer<Utf16>"})," work as\nexpected?"]}),(0,s.jsxs)(n.p,{children:["Since ",(0,s.jsx)(n.code,{children:"path"})," is a ",(0,s.jsx)(n.code,{children:"Pointer<Utf16>"}),", calling ",(0,s.jsx)(n.code,{children:".toString()"})," on it will simply\nprint the ",(0,s.jsx)(n.strong,{children:"address"})," of the pointer, like this:"]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Pointer: address=0x1729cc18240\n"})}),(0,s.jsxs)(n.p,{children:["To convert the ",(0,s.jsx)(n.code,{children:"Pointer<Utf16>"})," to a Dart string, you need to use the\n",(0,s.jsx)(n.code,{children:".toDartString()"})," extension method, as shown in the example above."]})]}),"\n",(0,s.jsx)(n.h3,{id:"variable-length-results",children:"Variable-Length Results"}),"\n",(0,s.jsxs)(n.p,{children:["Some APIs require a ",(0,s.jsx)(n.strong,{children:"two-pass"})," pattern:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Call with a null or zero-length buffer to obtain the required size"}),"\n",(0,s.jsx)(n.li,{children:"Allocate a buffer of the reported size"}),"\n",(0,s.jsx)(n.li,{children:"Call again to retrieve the data"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"String getPathEnvironmentVariable() {\n  return using((arena) {\n    final name = arena.pcwstr('PATH');\n    var Win32Result(value: length, :error) = GetEnvironmentVariable(\n      name,\n      null,\n      0,\n    );\n    if (length == 0) throw WindowsException(error.toHRESULT());\n\n    // highlight-next-line\n    final buffer = arena.pwstrBuffer(length);\n    Win32Result(value: length, :error) = GetEnvironmentVariable(\n      name,\n      buffer,\n      length,\n    );\n    if (length == 0) throw WindowsException(error.toHRESULT());\n\n    // highlight-next-line\n    return buffer.toDartString();\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This pattern is common for APIs that return ",(0,s.jsx)(n.strong,{children:"variable-length"})," strings."]}),"\n",(0,s.jsxs)(n.h2,{id:"multi_sz-strings",children:[(0,s.jsx)(n.code,{children:"MULTI_SZ"})," Strings"]}),"\n",(0,s.jsxs)(n.p,{children:["Some Win32 APIs expect a double-NUL-terminated UTF-16 string block (",(0,s.jsx)(n.code,{children:"MULTI_SZ"}),")."]}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringListExtension/toPcwstr.html",children:(0,s.jsx)(n.code,{children:"StringListExtension.toPcwstr()"})})," or\n",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/StringListExtension/toPwstr.html",children:(0,s.jsx)(n.code,{children:"StringListExtension.toPwstr()"})})," to convert a Dart\n",(0,s.jsx)(n.code,{children:"List<String>"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"const values = ['banana', 'strawberry', 'kiwi'];\nusing((arena) {\n  final multiSz = values.toPcwstr(allocator: arena);\n  // Pass to registry or shell APIs\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"The resulting memory layout:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Each string terminated by a NUL"}),"\n",(0,s.jsx)(n.li,{children:"A final extra NUL marking the end of the list"}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453(e,n,t){t.d(n,{R:()=>l,x:()=>a});var r=t(96540);let s={},i=r.createContext(s);function l(e){let n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);