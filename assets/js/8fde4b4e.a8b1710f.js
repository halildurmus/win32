"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["7212"],{85767(e,n,a){a.r(n),a.d(n,{metadata:()=>i,default:()=>h,frontMatter:()=>l,contentTitle:()=>t,toc:()=>o,assets:()=>c});var i=JSON.parse('{"id":"advanced/com/basic-concepts","title":"Basic Concepts","description":"Since package:win32 primarily focuses on providing a","source":"@site/docs/advanced/com/basic-concepts.md","sourceDirName":"advanced/com","slug":"/advanced/com/basic-concepts","permalink":"/docs/advanced/com/basic-concepts","draft":false,"unlisted":false,"editUrl":"https://github.com/halildurmus/win32/tree/main/website/docs/advanced/com/basic-concepts.md","tags":[],"version":"current","lastUpdatedBy":"Halil Durmus","lastUpdatedAt":1772220481000,"frontMatter":{"title":"Basic Concepts"},"sidebar":"mainSidebar","previous":{"title":"COM","permalink":"/docs/advanced/com"},"next":{"title":"Methods","permalink":"/docs/advanced/com/methods"}}'),s=a(74848),r=a(28453);let l={title:"Basic Concepts"},t,c={},o=[{value:"Initializing the COM Library",id:"initializing-the-com-library",level:2},{value:"The Scoped Ownership Model (Recommended)",id:"the-scoped-ownership-model-recommended",level:2},{value:"Creating COM Objects",id:"creating-com-objects",level:2},{value:"Low-level (C-style)",id:"low-level-c-style",level:3},{value:"Recommended: ArenaExtension.com()",id:"recommended-arenaextensioncom",level:3},{value:"Requesting an Interface from a COM Object",id:"requesting-an-interface-from-a-com-object",level:2},{value:"Recommended: ArenaExtension.adopt()",id:"recommended-arenaextensionadopt",level:3},{value:"Releasing COM Objects",id:"releasing-com-objects",level:2},{value:"Manual Release (Low-level)",id:"manual-release-low-level",level:3},{value:"Recommended: Let the Arena Manage Lifetime",id:"recommended-let-the-arena-manage-lifetime",level:3}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Since ",(0,s.jsx)(n.a,{href:"https://pub.dev/packages/win32",children:(0,s.jsx)(n.code,{children:"package:win32"})})," primarily focuses on providing a\n",(0,s.jsx)(n.strong,{children:"lightweight wrapper"})," over the underlying Windows API, you can use the same\nCOM APIs described in Microsoft documentation to create and manipulate objects\n(e.g., ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance",children:(0,s.jsx)(n.code,{children:"CoCreateInstance()"})})," and\n",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(refiid_void)",children:(0,s.jsx)(n.code,{children:"IUnknown::QueryInterface()"})}),")."]}),"\n",(0,s.jsxs)(n.p,{children:["However, a direct C-style approach introduces significant ",(0,s.jsx)(n.strong,{children:"boilerplate"})," and\n",(0,s.jsx)(n.strong,{children:"manual lifetime management"}),", which is both error-prone and non-idiomatic in\nDart."]}),"\n",(0,s.jsxs)(n.p,{children:["To address this, the library provides a more ergonomic approach using\n",(0,s.jsxs)(n.strong,{children:["scope-based lifetime management with ",(0,s.jsx)(n.code,{children:"Arena"})]}),". This eliminates most manual\ncleanup, and is the ",(0,s.jsx)(n.strong,{children:"recommended"})," way to work with COM APIs."]}),"\n",(0,s.jsx)(n.h2,{id:"initializing-the-com-library",children:"Initializing the COM Library"}),"\n",(0,s.jsxs)(n.p,{children:["Before calling any COM APIs, you must initialize the COM library by calling\n",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/combaseapi/nf-combaseapi-coinitializeex",children:(0,s.jsx)(n.code,{children:"CoInitializeEx()"})}),". Threading models are outside the scope of\nthis guide, but a typical initialization looks like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"CoInitializeEx(COINIT_MULTITHREADED);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You usually do this ",(0,s.jsx)(n.strong,{children:"once"})," near program startup. The examples below assume COM\nhas already been initialized."]}),"\n",(0,s.jsx)(n.h2,{id:"the-scoped-ownership-model-recommended",children:"The Scoped Ownership Model (Recommended)"}),"\n",(0,s.jsxs)(n.p,{children:["The library uses an ",(0,s.jsx)(n.strong,{children:"arena-based lifetime model"})," built on ",(0,s.jsx)(n.code,{children:"using()"})," and\n",(0,s.jsx)(n.code,{children:"Arena"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["An ",(0,s.jsx)(n.code,{children:"Arena"})," acts as a ",(0,s.jsx)(n.strong,{children:"native lifetime boundary:"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Memory allocated in the arena is freed together"}),"\n",(0,s.jsxs)(n.li,{children:["COM interfaces have ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/IUnknown/release.html",children:(0,s.jsx)(n.code,{children:"IUnknown.release()"})})," called exactly\nonce"]}),"\n",(0,s.jsx)(n.li,{children:"Native strings are destroyed using their correct deallocator"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Any resource created or adopted through arena helpers is ",(0,s.jsx)(n.strong,{children:"owned by the arena"}),"\nand is automatically released when the arena is disposed."]}),"\n",(0,s.jsx)(n.p,{children:"This eliminates the need for manual cleanup and makes ownership explicit at the\nAPI boundary."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final shell = arena.com<IShellItem>(ShellItem);\n  final path  = arena.pcwstr(r'C:\\Windows');\n  // Native resources are safe to use within this scope.\n});\n// All associated native resources are released here.\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If an object is created or adopted through these helpers, its lifetime is\n",(0,s.jsx)(n.strong,{children:"exactly equal to the lifetime of the arena"})," and must not be managed manually."]}),"\n",(0,s.jsx)(n.h2,{id:"creating-com-objects",children:"Creating COM Objects"}),"\n",(0,s.jsx)(n.h3,{id:"low-level-c-style",children:"Low-level (C-style)"}),"\n",(0,s.jsxs)(n.p,{children:["You can create COM objects using ",(0,s.jsx)(n.code,{children:"CoCreateInstance()"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n final rclsid = FileOpenDialog.toNative(allocator: arena);\n final fileDialog = CoCreateInstance<IFileDialog>(rclsid, null, CLSCTX_ALL);\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"This approach requires you to:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Allocate the native ",(0,s.jsx)(n.code,{children:"GUID"})," manually"]}),"\n",(0,s.jsx)(n.li,{children:"Track and release the COM object yourself"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"It is correct, but unnecessarily verbose."}),"\n",(0,s.jsxs)(n.h3,{id:"recommended-arenaextensioncom",children:["Recommended: ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/com.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.com()"})})]}),"\n",(0,s.jsx)(n.p,{children:"Instead, use the arena helper:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final fileDialog = arena.com<IFileDialog>(FileOpenDialog);\n  fileDialog.setTitle(arena.pcwstr('Select a file'));\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ArenaExtension.com()"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Calls ",(0,s.jsx)(n.code,{children:"CoCreateInstance()"})]}),"\n",(0,s.jsx)(n.li,{children:"Transfers ownership of the initial reference to the arena"}),"\n",(0,s.jsxs)(n.li,{children:["Ensures ",(0,s.jsx)(n.code,{children:"release()"})," is called exactly once when the arena is disposed"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The returned interface is safe to use for the duration of the arena scope and\n",(0,s.jsx)(n.strong,{children:"must not"})," be manually released."]}),"\n",(0,s.jsx)(n.h2,{id:"requesting-an-interface-from-a-com-object",children:"Requesting an Interface from a COM Object"}),"\n",(0,s.jsxs)(n.p,{children:["COM objects can implement multiple interfaces, but you cannot simply cast an\nobject to a different interface. Instead, you must request a pointer to a\nspecific interface using ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/IUnknown/queryInterface.html",children:(0,s.jsx)(n.code,{children:"IUnknown.queryInterface()"})}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Every COM interface in ",(0,s.jsx)(n.code,{children:"package:win32"})," derives from ",(0,s.jsx)(n.code,{children:"IUnknown"}),", so you can call\n",(0,s.jsx)(n.code,{children:"queryInterface()"})," on any object:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final modalWindow = fileDialog.queryInterface<IModalWindow>();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, you can use the ",(0,s.jsx)(n.code,{children:"from()"})," constructor, which wraps\n",(0,s.jsx)(n.code,{children:"queryInterface()"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"final modalWindow = IModalWindow.from(fileDialog);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Attempting to cast a COM object to an unsupported interface throws a\n",(0,s.jsx)(n.code,{children:"WindowsException"})," with an ",(0,s.jsx)(n.code,{children:"hr"})," of ",(0,s.jsx)(n.code,{children:"E_NOINTERFACE"}),"."]}),"\n",(0,s.jsxs)(n.h3,{id:"recommended-arenaextensionadopt",children:["Recommended: ",(0,s.jsx)(n.a,{href:"https://pub.dev/documentation/win32/latest/win32/ArenaExtension/adopt.html",children:(0,s.jsx)(n.code,{children:"ArenaExtension.adopt()"})})]}),"\n",(0,s.jsxs)(n.p,{children:["When you query a secondary interface, COM returns a ",(0,s.jsx)(n.strong,{children:"new reference"}),". That\nreference must be released separately."]}),"\n",(0,s.jsx)(n.p,{children:"If you are using the arena model, you should adopt the new interface into the\nsame arena:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final dialog  = arena.com<IFileOpenDialog>(FileOpenDialog);\n  // highlight-next-line\n  final dialog2 = arena.adopt(dialog.queryInterface<IFileDialog2>());\n  // Both interfaces are now owned by the arena.\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ArenaExtension.adopt()"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Transfers ownership of an already-created COM interface to the arena"}),"\n",(0,s.jsxs)(n.li,{children:["Ensures ",(0,s.jsx)(n.code,{children:"release()"})," is called exactly once when the arena is disposed"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["After adoption, the object ",(0,s.jsx)(n.strong,{children:"must not"})," be manually released."]}),"\n",(0,s.jsx)(n.h2,{id:"releasing-com-objects",children:"Releasing COM Objects"}),"\n",(0,s.jsx)(n.h3,{id:"manual-release-low-level",children:"Manual Release (Low-level)"}),"\n",(0,s.jsxs)(n.p,{children:["At the COM level, releasing an object is done by calling ",(0,s.jsx)(n.code,{children:"release()"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"fileDialog.release();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This is necessary to prevent ",(0,s.jsx)(n.strong,{children:"memory leaks"})," and ensure the object's memory is\nproperly released."]}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["If you manage COM lifetimes manually, you must do this in a ",(0,s.jsx)(n.code,{children:"try"})," / ",(0,s.jsx)(n.code,{children:"finally"}),"\nblock to guarantee cleanup even when exceptions are thrown."]})}),"\n",(0,s.jsx)(n.h3,{id:"recommended-let-the-arena-manage-lifetime",children:"Recommended: Let the Arena Manage Lifetime"}),"\n",(0,s.jsxs)(n.p,{children:["When you use ",(0,s.jsx)(n.code,{children:"ArenaExtension.com()"})," or ",(0,s.jsx)(n.code,{children:"ArenaExtension.adopt()"}),", you\n",(0,s.jsx)(n.strong,{children:"must not"})," call ",(0,s.jsx)(n.code,{children:"release()"})," yourself."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",children:"using((arena) {\n  final dialog = arena.com<IFileOpenDialog>(FileOpenDialog);\n  // The arena will call release on `dialog` when this block exits.\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"This model guarantees:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Exactly-once ",(0,s.jsx)(n.code,{children:"release()"})," call"]}),"\n",(0,s.jsx)(n.li,{children:"No leaks"}),"\n",(0,s.jsx)(n.li,{children:"No double-free errors"}),"\n",(0,s.jsx)(n.li,{children:"No forgotten cleanup on exceptional paths"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Letting COM interfaces escape the arena scope is a logic error and will\ninevitably lead to ",(0,s.jsx)(n.strong,{children:"use-after-free"})," bugs."]})]})}function h(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453(e,n,a){a.d(n,{R:()=>l,x:()=>t});var i=a(96540);let s={},r=i.createContext(s);function l(e){let n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);