"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["967"],{1568:function(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>o});var i=t(7151),s=t(5893),r=t(65);let a={title:"Building a Service Manager CLI in Dart with win32",description:"We'll build a command-line interface (CLI) to manage Windows services in Dart using the win32 package.",slug:"building-service-manager-cli",authors:"halildurmus",tags:["win32","dart","tutorial","cli"],image:"https://ik.imagekit.io/npajaqrcn/blog/2024-07-13-building-service-manager-cli/social.png",hide_table_of_contents:!1},c=void 0,l={authorsImageUrls:[void 0]},o=[{value:"Introduction",id:"introduction",level:2},{value:"Feature Overview",id:"feature-overview",level:2},{value:"Setting Up the Project",id:"setting-up-the-project",level:2},{value:"Creating a New Dart Project",id:"creating-a-new-dart-project",level:3},{value:"Installing Dependencies",id:"installing-dependencies",level:3},{value:"Defining the Models",id:"defining-the-models",level:2},{value:"Implementing Service Manager Logic",id:"implementing-service-manager-logic",level:2},{value:"Enumerating Services",id:"enumerating-services",level:3},{value:"Starting a Service",id:"starting-a-service",level:3},{value:"Stopping a Service",id:"stopping-a-service",level:3},{value:"Querying Service Status",id:"querying-service-status",level:3},{value:"Building the CLI",id:"building-the-cli",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"Source Code",id:"source-code",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components},{CommonViewSourceCode:t}=n;return t||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("CommonViewSourceCode",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(n.p,{children:["In this blog post, we will explore how to build a Service Manager CLI in Dart\nusing the ",(0,s.jsx)(n.strong,{children:"win32"})," package. By leveraging the Windows APIs provided by\n",(0,s.jsx)(n.strong,{children:"win32"}),", we'll create a robust command-line tool that can\n",(0,s.jsx)(n.strong,{children:"enumerate services"}),", ",(0,s.jsx)(n.strong,{children:"start and stop services"}),", and\n",(0,s.jsx)(n.strong,{children:"query service status"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Whether you're looking to enhance your development toolkit or simply learn more\nabout integrating Dart with Windows system functionalities, this guide will\nprovide you with the insights and steps necessary to build your own service\nmanager from scratch."}),"\n",(0,s.jsx)(n.p,{children:"Here's what we'll cover:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#feature-overview",children:"Feature Overview"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#setting-up-the-project",children:"Setting Up the Project"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#creating-a-new-dart-project",children:"Creating a New Dart Project"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#installing-dependencies",children:"Installing Dependencies"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#defining-the-models",children:"Defining the Models"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#implementing-service-manager-logic",children:"Implementing Service Manager Logic"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#enumerating-services",children:"Enumerating Services"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#starting-a-service",children:"Starting a Service"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#stopping-a-service",children:"Stopping a Service"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#querying-service-status",children:"Querying Service Status"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#building-the-cli",children:"Building the CLI"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#conclusion",children:"Conclusion"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#source-code",children:"Source Code"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"feature-overview",children:"Feature Overview"}),"\n",(0,s.jsx)(n.p,{children:"Our Service Manager CLI will include the following key features:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Enumerating services:"})," View a set of all available services on the system."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Starting and stopping a service:"})," Start or stop a service by its name."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Querying service status:"})," Retrieve the current operational status of a\nservice by its name."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"setting-up-the-project",children:"Setting Up the Project"}),"\n",(0,s.jsx)(n.p,{children:"Before we dive into coding, let\u2019s set up our project."}),"\n",(0,s.jsx)(n.h3,{id:"creating-a-new-dart-project",children:"Creating a New Dart Project"}),"\n",(0,s.jsx)(n.p,{children:"Open your terminal and run:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cmd",metastring:'title="Terminal"',children:"> dart create service_manager_cli\n> cd service_manager_cli\n"})}),"\n",(0,s.jsx)(n.h3,{id:"installing-dependencies",children:"Installing Dependencies"}),"\n",(0,s.jsxs)(n.p,{children:["Add the ",(0,s.jsx)(n.strong,{children:"ffi"})," and ",(0,s.jsx)(n.strong,{children:"win32"})," packages to your project with:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cmd",metastring:'title="Terminal"',children:"dart pub add ffi win32\n"})}),"\n",(0,s.jsx)(n.h2,{id:"defining-the-models",children:"Defining the Models"}),"\n",(0,s.jsxs)(n.p,{children:["We'll start by defining the models responsible for storing\n",(0,s.jsx)(n.strong,{children:"service information"})," and result details for ",(0,s.jsx)(n.strong,{children:"start"})," and ",(0,s.jsx)(n.strong,{children:"stop"}),"\noperations."]}),"\n",(0,s.jsxs)(n.p,{children:["Create a new file named ",(0,s.jsx)(n.code,{children:"models.dart"})," in the ",(0,s.jsx)(n.code,{children:"lib\\src"})," directory and add the\nfollowing code:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib\\src\\models.dart"',children:"import 'package:win32/win32.dart';\n\n/// The result of an attempt to start a service.\nenum ServiceStartResult {\n  /// The attempt to start the service was denied due to insufficient\n  /// permissions.\n  accessDenied,\n\n  /// The service is already running.\n  alreadyRunning,\n\n  /// The attempt to start the service failed for an unspecified reason.\n  failed,\n\n  /// The service was started successfully.\n  success,\n\n  /// The attempt to start the service timed out.\n  timedOut,\n}\n\n/// The various states a service can be in.\nenum ServiceStatus {\n  /// The service is not running.\n  stopped,\n\n  /// The service is in the process of starting.\n  startPending,\n\n  /// The service is in the process of stopping.\n  stopPending,\n\n  /// The service is running.\n  running,\n\n  /// The service is in the process of resuming from a paused state.\n  continuePending,\n\n  /// The service is in the process of being paused.\n  pausePending,\n\n  /// The service is paused.\n  paused;\n\n  /// Converts an integer value to a corresponding [ServiceStatus] enum.\n  ///\n  /// Throws an [ArgumentError] if the value does not correspond to a valid\n  /// value.\n  static ServiceStatus fromValue(int value) => switch (value) {\n        SERVICE_STOPPED => ServiceStatus.stopped,\n        SERVICE_START_PENDING => ServiceStatus.startPending,\n        SERVICE_STOP_PENDING => ServiceStatus.stopPending,\n        SERVICE_RUNNING => ServiceStatus.running,\n        SERVICE_CONTINUE_PENDING => ServiceStatus.continuePending,\n        SERVICE_PAUSE_PENDING => ServiceStatus.pausePending,\n        SERVICE_PAUSED => ServiceStatus.paused,\n        _ => throw ArgumentError('Invalid value: $value')\n      };\n}\n\n/// The result of an attempt to stop a service.\nenum ServiceStopResult {\n  /// The attempt to stop the service was denied due to insufficient\n  /// permissions.\n  accessDenied,\n\n  /// The service is already stopped.\n  alreadyStopped,\n\n  /// The attempt to stop the service failed for an unspecified reason.\n  failed,\n\n  /// The service was stopped successfully.\n  success,\n\n  /// The attempt to stop the service timed out.\n  timedOut,\n}\n\n/// A Windows service with its name, display name, and current status.\nclass Service {\n  const Service({\n    required this.displayName,\n    required this.name,\n    required this.status,\n  });\n\n  /// The display name of the service.\n  final String displayName;\n\n  /// The name of the service.\n  final String name;\n\n  /// The current status of the service.\n  final ServiceStatus status;\n\n  @override\n  String toString() =>\n      'Service(displayName: $displayName, name: $name, status: $status)';\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"implementing-service-manager-logic",children:"Implementing Service Manager Logic"}),"\n",(0,s.jsx)(n.p,{children:"Next, we'll implement the core functionality for managing Windows services,\nincluding enumerating services, starting and stopping services, and querying\nservice status."}),"\n",(0,s.jsxs)(n.p,{children:["Create a new file named ",(0,s.jsx)(n.code,{children:"service_manager.dart"})," in the ",(0,s.jsx)(n.code,{children:"lib\\src"})," directory and\nadd the following code to set up the skeleton for managing Windows services:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib\\src\\service_manager.dart"',children:"import 'dart:collection';\nimport 'dart:ffi';\n\nimport 'package:ffi/ffi.dart';\nimport 'package:win32/win32.dart';\n\nimport 'models.dart';\n\n/// Provides functionality for managing Windows services, including:\n/// - Enumerating available services\n/// - Starting and stopping services\n/// - Retrieving the current status of services\nabstract class ServiceManager {\n  /// Whether to log informative messages to the console.\n  static bool log = false;\n\n  /// Retrieves a set of all services (sorted by display name).\n  static Set<Service> get services {\n    // TODO: Implement this method\n    throw UnimplementedError();\n  }\n\n  /// Starts a service defined by [serviceName].\n  static ServiceStartResult start(String serviceName) {\n    // TODO: Implement this method\n    throw UnimplementedError();\n  }\n\n  /// Stops a service defined by [serviceName].\n  static ServiceStopResult stop(String serviceName) {\n    // TODO: Implement this method\n    throw UnimplementedError();\n  }\n\n  /// Retrieves the status of a service defined by [serviceName].\n  static ServiceStatus? status(String serviceName) {\n    // TODO: Implement this method\n    throw UnimplementedError();\n  }\n\n  /// Logs a message to the console if [log] is `true`.\n  static void _log(String message) {\n    if (log) print(message);\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"With the skeleton in place, we can start implementing the service manager logic."}),"\n",(0,s.jsx)(n.h3,{id:"enumerating-services",children:"Enumerating Services"}),"\n",(0,s.jsxs)(n.p,{children:["Now, let's implement the ",(0,s.jsx)(n.code,{children:"services"})," getter to ",(0,s.jsx)(n.strong,{children:"enumerate all services"})," on the\nsystem."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib\\src\\service_manager.dart"',children:"/// Retrieves a set of all services (sorted by display name).\nstatic Set<Service> get services {\n  final services =\n      SplayTreeSet<Service>((a, b) => a.displayName.compareTo(b.displayName));\n\n  // Get a handle to the SCM database.\n  final scmHandle =\n      OpenSCManager(nullptr, nullptr, SC_MANAGER_ENUMERATE_SERVICE);\n  if (scmHandle == NULL) return services;\n\n  return using((arena) {\n    try {\n      final bytesNeeded = arena<DWORD>();\n      final servicesReturned = arena<DWORD>();\n      final resumeHandle = arena<DWORD>();\n\n      _log('Getting service list...');\n\n      // First call to EnumServicesStatusEx to get the required buffer size.\n      EnumServicesStatusEx(\n        scmHandle,\n        SC_ENUM_PROCESS_INFO,\n        SERVICE_WIN32,\n        SERVICE_STATE_ALL,\n        nullptr,\n        0,\n        bytesNeeded,\n        servicesReturned,\n        resumeHandle,\n        nullptr,\n      );\n\n      final buffer = arena<BYTE>(bytesNeeded.value);\n\n      // Second call to EnumServicesStatusEx to get the actual data.\n      if (EnumServicesStatusEx(\n            scmHandle,\n            SC_ENUM_PROCESS_INFO,\n            SERVICE_WIN32,\n            SERVICE_STATE_ALL,\n            buffer,\n            bytesNeeded.value,\n            bytesNeeded,\n            servicesReturned,\n            resumeHandle,\n            nullptr,\n          ) !=\n          FALSE) {\n        final enumBuffer = buffer.cast<ENUM_SERVICE_STATUS_PROCESS>();\n        for (var i = 0; i < servicesReturned.value; i++) {\n          final serviceStatus = (enumBuffer + i).ref;\n          final ENUM_SERVICE_STATUS_PROCESS(:lpServiceName, :lpDisplayName) =\n              serviceStatus;\n          final serviceName = lpServiceName.toDartString();\n          final displayName = lpDisplayName.toDartString();\n          final status = ServiceStatus.fromValue(\n            serviceStatus.ServiceStatusProcess.dwCurrentState,\n          );\n          final service = Service(\n            displayName: displayName,\n            name: serviceName,\n            status: status,\n          );\n          services.add(service);\n        }\n      }\n    } finally {\n      CloseServiceHandle(scmHandle);\n    }\n\n    return services;\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["We first obtain a handle to the Service Control Manager (SCM) database using\n",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/winsvc/nf-winsvc-openscmanagerw",children:"OpenSCManager"}),", which allows us to interact with the SCM to query, start, stop,\nand configure services. We then make an initial call to ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/winsvc/nf-winsvc-enumservicesstatusexw",children:"EnumServicesStatusEx"}),"\nto determine the required buffer size for storing the service information. With\nthe necessary buffer allocated, we make a second call to ",(0,s.jsx)(n.code,{children:"EnumServicesStatusEx"}),"\nto retrieve the actual service data. Iterating through the services, we convert\nthem into ",(0,s.jsx)(n.code,{children:"Service"})," objects and add them to a sorted set."]}),"\n",(0,s.jsx)(n.p,{children:"Throughout this process, we log informative messages to track progress and\nerrors. If we fail to open the SCM or enumerate services, we ensure appropriate\nerror handling and logging."}),"\n",(0,s.jsx)(n.h3,{id:"starting-a-service",children:"Starting a Service"}),"\n",(0,s.jsxs)(n.p,{children:["Next, we\u2019ll implement the ",(0,s.jsx)(n.code,{children:"start"})," function to ",(0,s.jsx)(n.strong,{children:"start a service"})," with\n",(0,s.jsx)(n.code,{children:"serviceName"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib\\src\\service_manager.dart"',children:"/// Starts a service defined by [serviceName].\nstatic ServiceStartResult start(String serviceName) {\n  // Get a handle to the SCM database.\n  final scmHandle = OpenSCManager(\n    nullptr, // local computer\n    nullptr, // ServicesActive database\n    SC_MANAGER_ALL_ACCESS, // full access rights\n  );\n  if (scmHandle == NULL) return ServiceStartResult.accessDenied;\n\n  return using((arena) {\n    // Get a handle to the service.\n    final hService = OpenService(\n      scmHandle,\n      serviceName.toNativeUtf16(allocator: arena),\n      SERVICE_ALL_ACCESS,\n    );\n    if (hService == NULL) {\n      CloseServiceHandle(scmHandle);\n      return ServiceStartResult.failed;\n    }\n\n    final lpBuffer = arena<SERVICE_STATUS_PROCESS>();\n    final bytesNeeded = arena<DWORD>();\n\n    // Check the status in case the service is not stopped.\n    if (QueryServiceStatusEx(\n          hService,\n          SC_STATUS_PROCESS_INFO,\n          lpBuffer.cast(),\n          sizeOf<SERVICE_STATUS_PROCESS>(),\n          bytesNeeded,\n        ) ==\n        FALSE) {\n      CloseServiceHandle(hService);\n      CloseServiceHandle(scmHandle);\n      return ServiceStartResult.failed;\n    }\n\n    final ssp = lpBuffer.ref;\n\n    // Check if the service is already running. It would be possible to stop\n    // the service here, but for simplicity this example just returns.\n    if (ssp.dwCurrentState != SERVICE_STOPPED &&\n        ssp.dwCurrentState != SERVICE_STOP_PENDING) {\n      CloseServiceHandle(hService);\n      CloseServiceHandle(scmHandle);\n      return ServiceStartResult.alreadyRunning;\n    }\n\n    // Save the tick count and initial checkpoint.\n    var startTickCount = GetTickCount();\n    var oldCheckPoint = ssp.dwCheckPoint;\n\n    // If a stop is pending, wait for it.\n    while (ssp.dwCurrentState == SERVICE_STOP_PENDING) {\n      _log('Service stop pending...');\n\n      // Do not wait longer than the wait hint. A good interval is one-tenth\n      // of the wait hint but not less than 1 second and not more than 10\n      // seconds.\n\n      var waitTime = ssp.dwWaitHint ~/ 10;\n      waitTime = waitTime < 1000\n          ? 1000\n          : waitTime > 10000\n              ? 10000\n              : waitTime;\n      _log('Sleeping for ${ssp.dwWaitHint} ms...');\n      Sleep(waitTime);\n\n      // Check the status until the service is no longer stop pending.\n      if (QueryServiceStatusEx(\n            hService,\n            SC_STATUS_PROCESS_INFO,\n            lpBuffer.cast(),\n            sizeOf<SERVICE_STATUS_PROCESS>(),\n            bytesNeeded,\n          ) ==\n          FALSE) {\n        CloseServiceHandle(hService);\n        CloseServiceHandle(scmHandle);\n        return ServiceStartResult.failed;\n      }\n\n      if (ssp.dwCheckPoint > oldCheckPoint) {\n        // Continue to wait and check.\n        startTickCount = GetTickCount();\n        oldCheckPoint = ssp.dwCheckPoint;\n      } else if (GetTickCount() - startTickCount > ssp.dwWaitHint) {\n        CloseServiceHandle(hService);\n        CloseServiceHandle(scmHandle);\n        return ServiceStartResult.timedOut;\n      }\n    }\n\n    // Attempt to start the service.\n    if (StartService(hService, 0, nullptr) == FALSE) {\n      CloseServiceHandle(hService);\n      CloseServiceHandle(scmHandle);\n      return ServiceStartResult.failed;\n    } else {\n      _log('Service start pending...');\n    }\n\n    // Check the status until the service is no longer start pending.\n    if (QueryServiceStatusEx(\n          hService,\n          SC_STATUS_PROCESS_INFO,\n          lpBuffer.cast(),\n          sizeOf<SERVICE_STATUS_PROCESS>(),\n          bytesNeeded,\n        ) ==\n        FALSE) {\n      CloseServiceHandle(hService);\n      CloseServiceHandle(scmHandle);\n      return ServiceStartResult.failed;\n    }\n\n    // Save the tick count and initial checkpoint.\n    startTickCount = GetTickCount();\n    oldCheckPoint = ssp.dwCheckPoint;\n\n    while (ssp.dwCurrentState == SERVICE_START_PENDING) {\n      // Do not wait longer than the wait hint. A good interval is one-tenth\n      // of the wait hint but not less than 1 second and not more than 10\n      // seconds.\n\n      var waitTime = ssp.dwWaitHint ~/ 10;\n      waitTime = waitTime < 1000\n          ? 1000\n          : waitTime > 10000\n              ? 10000\n              : waitTime;\n      _log('Sleeping for ${ssp.dwWaitHint} ms...');\n      Sleep(waitTime);\n\n      // Check the status again.\n      if (QueryServiceStatusEx(\n            hService,\n            SC_STATUS_PROCESS_INFO,\n            lpBuffer.cast(),\n            sizeOf<SERVICE_STATUS_PROCESS>(),\n            bytesNeeded,\n          ) ==\n          FALSE) {\n        break;\n      }\n\n      if (ssp.dwCheckPoint > oldCheckPoint) {\n        // Continue to wait and check.\n        startTickCount = GetTickCount();\n        oldCheckPoint = ssp.dwCheckPoint;\n      } else if (GetTickCount() - startTickCount > ssp.dwWaitHint) {\n        // No progress made within the wait hint.\n        break;\n      }\n    }\n\n    // Determine whether the service is running.\n    final serviceRunning = ssp.dwCurrentState == SERVICE_RUNNING;\n    CloseServiceHandle(hService);\n    CloseServiceHandle(scmHandle);\n\n    return serviceRunning\n        ? ServiceStartResult.success\n        : ServiceStartResult.failed;\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["We begin by obtaining a handle to the Service Control Manager (SCM) database\nusing ",(0,s.jsx)(n.code,{children:"OpenSCManager"})," with full access rights. If this fails, we return an\n",(0,s.jsx)(n.em,{children:"access denied"})," result. Next, we get a handle to the specific service using\n",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/winsvc/nf-winsvc-openservicew",children:"OpenService"}),". If this fails, we close the SCM handle and return a ",(0,s.jsx)(n.em,{children:"failure"}),"\nresult."]}),"\n",(0,s.jsxs)(n.p,{children:["We then check the service's status using ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/winsvc/nf-winsvc-queryservicestatusex",children:"QueryServiceStatusEx"}),". If the service\nis not stopped, we return an ",(0,s.jsx)(n.em,{children:"already running"})," result. If the service is\nstopping, we wait for it to finish stopping, periodically checking its status\nand updating our wait time based on the service's wait hint."]}),"\n",(0,s.jsxs)(n.p,{children:["Once the service is stopped, we attempt to start it using ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/winsvc/nf-winsvc-startservicew",children:"StartService"}),". We\nthen check the service's status again, waiting for it to finish starting. If the\nservice starts successfully and transitions to the running state, we return a\n",(0,s.jsx)(n.em,{children:"success"})," result; otherwise, we return a ",(0,s.jsx)(n.em,{children:"failure"})," result."]}),"\n",(0,s.jsx)(n.p,{children:"Throughout this process, we log informative messages and ensure proper resource\nmanagement by closing all handles when done."}),"\n",(0,s.jsx)(n.h3,{id:"stopping-a-service",children:"Stopping a Service"}),"\n",(0,s.jsxs)(n.p,{children:["Next, we\u2019ll implement the ",(0,s.jsx)(n.code,{children:"stop"})," function to ",(0,s.jsx)(n.strong,{children:"stop a service"})," with\n",(0,s.jsx)(n.code,{children:"serviceName"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib\\src\\service_manager.dart"',children:"/// Stops a service defined by [serviceName].\nstatic ServiceStopResult stop(String serviceName) {\n  // Get a handle to the SCM database.\n  final scmHandle = OpenSCManager(\n    nullptr, // local computer\n    nullptr, // ServicesActive database\n    SC_MANAGER_ALL_ACCESS, // full access rights\n  );\n  if (scmHandle == NULL) return ServiceStopResult.accessDenied;\n\n  return using((arena) {\n    // Get a handle to the service.\n    final hService = OpenService(\n      scmHandle,\n      serviceName.toNativeUtf16(allocator: arena),\n      SERVICE_STOP | SERVICE_QUERY_STATUS | SERVICE_ENUMERATE_DEPENDENTS,\n    );\n    if (hService == NULL) {\n      CloseServiceHandle(scmHandle);\n      return ServiceStopResult.failed;\n    }\n\n    try {\n      final lpBuffer = arena<SERVICE_STATUS_PROCESS>();\n      final bytesNeeded = arena<DWORD>();\n\n      // Make sure the service is not already stopped.\n      if (QueryServiceStatusEx(\n            hService,\n            SC_STATUS_PROCESS_INFO,\n            lpBuffer.cast(),\n            sizeOf<SERVICE_STATUS_PROCESS>(),\n            bytesNeeded,\n          ) ==\n          FALSE) {\n        return ServiceStopResult.failed;\n      }\n\n      final ssp = lpBuffer.ref;\n      if (ssp.dwCurrentState == SERVICE_STOPPED) {\n        return ServiceStopResult.alreadyStopped;\n      }\n\n      final startTime = GetTickCount();\n      const timeout = 30000; // 30-second timeout\n\n      // If a stop is pending, wait for it.\n      while (ssp.dwCurrentState == SERVICE_STOP_PENDING) {\n        _log('Service stop pending...');\n\n        // Do not wait longer than the wait hint. A good interval is one-tenth\n        // of the wait hint but not less than 1 second and not more than 10\n        // seconds.\n\n        var waitTime = ssp.dwWaitHint ~/ 10;\n        waitTime = waitTime < 1000\n            ? 1000\n            : waitTime > 10000\n                ? 10000\n                : waitTime;\n        _log('Sleeping for ${ssp.dwWaitHint} ms...');\n        Sleep(waitTime);\n\n        if (QueryServiceStatusEx(\n              hService,\n              SC_STATUS_PROCESS_INFO,\n              lpBuffer.cast(),\n              sizeOf<SERVICE_STATUS_PROCESS>(),\n              bytesNeeded,\n            ) ==\n            FALSE) {\n          return ServiceStopResult.failed;\n        }\n\n        if (ssp.dwCurrentState == SERVICE_STOPPED) {\n          return ServiceStopResult.success;\n        }\n\n        if (GetTickCount() - startTime > timeout) {\n          return ServiceStopResult.timedOut;\n        }\n      }\n\n      // If the service is running, dependencies must be stopped first.\n      final result = _stopDependentServices(hService, scmHandle);\n      if (result\n          case ServiceStopResult.accessDenied ||\n              ServiceStopResult.failed ||\n              ServiceStopResult.timedOut) {\n        return result;\n      }\n\n      // Send a stop code to the service.\n      if (ControlService(\n            hService,\n            SERVICE_CONTROL_STOP,\n            lpBuffer.cast<SERVICE_STATUS>(),\n          ) ==\n          FALSE) {\n        return ServiceStopResult.failed;\n      }\n\n      // Wait for the service to stop.\n\n      _log('Service stop pending...');\n\n      while (ssp.dwCurrentState != SERVICE_STOPPED) {\n        _log('Sleeping for ${ssp.dwWaitHint} ms...');\n        Sleep(ssp.dwWaitHint);\n\n        if (QueryServiceStatusEx(\n              hService,\n              SC_STATUS_PROCESS_INFO,\n              lpBuffer.cast(),\n              sizeOf<SERVICE_STATUS_PROCESS>(),\n              bytesNeeded,\n            ) ==\n            FALSE) {\n          return ServiceStopResult.failed;\n        }\n\n        if (ssp.dwCurrentState == SERVICE_STOPPED) break;\n\n        if (GetTickCount() - startTime > timeout) {\n          return ServiceStopResult.timedOut;\n        }\n      }\n\n      return ServiceStopResult.success;\n    } finally {\n      CloseServiceHandle(hService);\n      CloseServiceHandle(scmHandle);\n    }\n  });\n}\n\n/// Stops dependent services of a service defined by [hService].\nstatic ServiceStopResult _stopDependentServices(\n  int hService,\n  int scmHandle,\n) {\n  return using((arena) {\n    final bytesNeeded = arena<DWORD>();\n    final servicesReturned = arena<DWORD>();\n\n    _log('Checking for dependent services...');\n\n    // Pass a zero-length buffer to get the required buffer size.\n    if (EnumDependentServices(\n          hService,\n          SERVICE_ACTIVE,\n          nullptr,\n          0,\n          bytesNeeded,\n          servicesReturned,\n        ) ==\n        TRUE) {\n      _log('No dependent services found.');\n    } else {\n      // Allocate a buffer for the dependencies.\n      final lpServices =\n          arena<BYTE>(bytesNeeded.value).cast<ENUM_SERVICE_STATUS>();\n\n      // Enumerate the dependencies.\n      if (EnumDependentServices(\n            hService,\n            SERVICE_ACTIVE,\n            lpServices,\n            bytesNeeded.value,\n            bytesNeeded,\n            servicesReturned,\n          ) ==\n          FALSE) {\n        return ServiceStopResult.failed;\n      }\n\n      _log('Found ${servicesReturned.value} dependent services:');\n      for (var i = 0; i < servicesReturned.value; i++) {\n        final ess = lpServices[i];\n        _log(' (${i + 1}/${servicesReturned.value}) Stopping '\n            '${ess.lpServiceName.toDartString()}...');\n\n        // Open the service.\n        final hDepService = OpenService(\n          scmHandle,\n          ess.lpServiceName,\n          SERVICE_STOP | SERVICE_QUERY_STATUS,\n        );\n        if (hDepService == NULL) return ServiceStopResult.failed;\n\n        try {\n          final lpServiceStatus = arena<SERVICE_STATUS_PROCESS>();\n\n          // Send a stop code.\n          if (ControlService(\n                hDepService,\n                SERVICE_CONTROL_STOP,\n                lpServiceStatus.cast<SERVICE_STATUS>(),\n              ) ==\n              FALSE) {\n            return ServiceStopResult.failed;\n          }\n\n          final startTime = GetTickCount();\n          const timeout = 30000; // 30-second timeout\n          final ssp = lpServiceStatus.ref;\n\n          // Wait for the service to stop.\n          while (ssp.dwCurrentState != SERVICE_STOPPED) {\n            _log('Sleeping for ${ssp.dwWaitHint} ms...');\n            Sleep(ssp.dwWaitHint);\n\n            if (QueryServiceStatusEx(\n                  hDepService,\n                  SC_STATUS_PROCESS_INFO,\n                  lpServiceStatus.cast(),\n                  sizeOf<SERVICE_STATUS_PROCESS>(),\n                  bytesNeeded,\n                ) ==\n                FALSE) {\n              return ServiceStopResult.failed;\n            }\n\n            if (ssp.dwCurrentState == SERVICE_STOPPED) break;\n\n            if (GetTickCount() - startTime > timeout) {\n              return ServiceStopResult.timedOut;\n            }\n          }\n        } finally {\n          // Always release the service handle.\n          CloseServiceHandle(hDepService);\n        }\n      }\n    }\n\n    _log('Dependent services stopped.');\n    return ServiceStopResult.success;\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.code,{children:"stop"})," function, we first obtain a handle to the Service Control Manager\n(SCM) database using ",(0,s.jsx)(n.code,{children:"OpenSCManager"})," with full access rights. If this fails, we\nreturn an ",(0,s.jsx)(n.em,{children:"access denied"})," result. Next, we get a handle to the specific service\nusing ",(0,s.jsx)(n.code,{children:"OpenService"}),", granting it stop, query status, and enumerate dependents\npermissions. If this fails, we close the SCM handle and return a ",(0,s.jsx)(n.em,{children:"failure"}),"\nresult."]}),"\n",(0,s.jsxs)(n.p,{children:["We then check the service's status using ",(0,s.jsx)(n.code,{children:"QueryServiceStatusEx"}),". If the service\nis already stopped, we return an ",(0,s.jsx)(n.em,{children:"already stopped"})," result. If the service is\nstopping, we wait for it to finish stopping, periodically checking its status\nand updating our wait time based on the service's wait hint. Once the service is\nno longer in the stop pending state, we attempt to stop any dependent services\nfirst using the ",(0,s.jsx)(n.code,{children:"_stopDependentServices"})," helper function."]}),"\n",(0,s.jsxs)(n.p,{children:["After ensuring dependent services are stopped, we send a stop code to the\nservice using ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/api/winsvc/nf-winsvc-controlservice",children:"ControlService"}),". We then wait for the service to transition to\nthe stopped state, periodically checking its status. If the service stops\nsuccessfully, we return a ",(0,s.jsx)(n.em,{children:"success"})," result; otherwise, we return a ",(0,s.jsx)(n.em,{children:"failure"})," or\n",(0,s.jsx)(n.em,{children:"timed out"})," result."]}),"\n",(0,s.jsxs)(n.p,{children:["Throughout this process, we log informative messages and ensure proper resource\nmanagement by closing all handles when done. The ",(0,s.jsx)(n.code,{children:"_stopDependentServices"}),"\nfunction enumerates and stops any active dependent services in a similar manner,\nensuring they are fully stopped before returning control to the main ",(0,s.jsx)(n.code,{children:"stop"}),"\nfunction."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["The implementations for ",(0,s.jsx)(n.code,{children:"start"})," and ",(0,s.jsx)(n.code,{children:"stop"})," functions are based on the C++\nexamples provided in the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/windows/win32/services/starting-a-service",children:"Microsoft documentation"}),"."]})}),"\n",(0,s.jsx)(n.h3,{id:"querying-service-status",children:"Querying Service Status"}),"\n",(0,s.jsxs)(n.p,{children:["Finally, let's implement the ",(0,s.jsx)(n.code,{children:"status"})," function to ",(0,s.jsx)(n.strong,{children:"query service status"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib\\src\\service_manager.dart"',children:"/// Retrieves the status of a service defined by [serviceName].\nstatic ServiceStatus? status(String serviceName) {\n  // Get a handle to the SCM database.\n  final scmHandle = OpenSCManager(nullptr, nullptr, SC_MANAGER_CONNECT);\n  if (scmHandle == NULL) return null;\n\n  return using((arena) {\n    // Get a handle to the service.\n    final hService = OpenService(\n      scmHandle,\n      serviceName.toNativeUtf16(allocator: arena),\n      SERVICE_QUERY_STATUS,\n    );\n    if (hService == NULL) {\n      CloseServiceHandle(scmHandle);\n      return null;\n    }\n\n    try {\n      final lpBuffer = arena<SERVICE_STATUS_PROCESS>();\n      final bytesNeeded = arena<DWORD>();\n\n      // Query the service status.\n      if (QueryServiceStatusEx(\n            hService,\n            SC_STATUS_PROCESS_INFO,\n            lpBuffer.cast(),\n            sizeOf<SERVICE_STATUS_PROCESS>(),\n            bytesNeeded,\n          ) ==\n          FALSE) {\n        return null;\n      }\n\n      return ServiceStatus.fromValue(lpBuffer.ref.dwCurrentState);\n    } finally {\n      CloseServiceHandle(hService);\n      CloseServiceHandle(scmHandle);\n    }\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["We first obtain a handle to the Service Control Manager (SCM) database using\n",(0,s.jsx)(n.code,{children:"OpenSCManager"})," with connect permissions. If this fails, we return ",(0,s.jsx)(n.code,{children:"null"}),". Next,\nwe get a handle to the specific service using ",(0,s.jsx)(n.code,{children:"OpenService"}),", granting it query\nstatus permissions. If this fails, we close the SCM handle and return ",(0,s.jsx)(n.code,{children:"null"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Using the ",(0,s.jsx)(n.code,{children:"QueryServiceStatusEx"})," function, we query the service's status. We\nallocate the necessary buffer to store the status information. If the query is\n",(0,s.jsx)(n.em,{children:"unsuccessful"}),", we return ",(0,s.jsx)(n.code,{children:"null"}),". If the query ",(0,s.jsx)(n.em,{children:"succeeds"}),", we retrieve the\nservice's current state and convert it into a ",(0,s.jsx)(n.code,{children:"ServiceStatus"})," object using\n",(0,s.jsx)(n.code,{children:"ServiceStatus.fromValue"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Throughout this process, we log informative messages and ensure proper resource\nmanagement by closing all handles when done. This ensures that the function\ncorrectly retrieves the status of a specified service, returning the appropriate\nstatus or ",(0,s.jsx)(n.code,{children:"null"})," if any step fails."]}),"\n",(0,s.jsx)(n.h2,{id:"building-the-cli",children:"Building the CLI"}),"\n",(0,s.jsx)(n.p,{children:"Now that we have implemented the functions to interact with Windows services,\nlet's create a CLI tool to manage services directly from the command line."}),"\n",(0,s.jsxs)(n.p,{children:["First, update the ",(0,s.jsx)(n.strong,{children:"lib\\service_manager_cli.dart"})," file to export the models and\nservice manager implementation:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="lib\\service_manager_cli.dart"',children:"library;\n\nexport 'src/models.dart';\nexport 'src/service_manager.dart';\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Next, replace the existing code in ",(0,s.jsx)(n.strong,{children:"bin\\service_manager_cli.dart"})," with the\nfollowing implementation for the CLI:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-dart",metastring:'title="bin\\service_manager_cli.dart"',children:"import 'dart:io';\n\nimport 'package:service_manager_cli/service_manager_cli.dart';\n\nvoid main(List<String> arguments) {\n  if (arguments.isEmpty ||\n      arguments.contains('-h') ||\n      arguments.contains('--help')) {\n    printUsage();\n    return;\n  }\n\n  bool verbose = false;\n  if (arguments.contains('-v') || arguments.contains('--verbose')) {\n    verbose = true;\n    arguments = arguments.where((arg) => arg != '-v').toList();\n  }\n\n  ServiceManager.log = verbose;\n\n  final command = arguments[0];\n  final serviceName = arguments.length > 1 ? arguments[1] : null;\n\n  switch (command) {\n    case 'list':\n      listServices();\n      break;\n\n    case 'start':\n      if (serviceName == null) {\n        print('Please provide the service name to start.');\n        exit(1);\n      }\n      startService(serviceName);\n      break;\n\n    case 'status':\n      if (serviceName == null) {\n        print('Please provide a service name to get status.');\n        exit(1);\n      }\n      status(serviceName);\n      break;\n\n    case 'stop':\n      if (serviceName == null) {\n        print('Please provide the service name to stop.');\n        exit(1);\n      }\n      stopService(serviceName);\n      break;\n\n    default:\n      print('Unknown command: $command');\n      print('');\n      printUsage();\n      exit(1);\n  }\n}\n\nvoid printUsage() {\n  print('A command-line interface for managing Windows services.');\n  print('');\n  print('Usage: service_manager_cli <command> [arguments]');\n  print('');\n  print('Global options:');\n  print('  -v, --verbose         Show additional command output.');\n  print('  -h, --help            Print this usage information.');\n  print('');\n  print('Available commands:');\n  print('  list                  List all services.');\n  print('  start <service_name>  Start a service.');\n  print('  status <service_name> Get the status of a service.');\n  print('  stop <service_name>   Stop a service.');\n}\n\nvoid listServices() {\n  final services = ServiceManager.services;\n  if (services.isEmpty) {\n    print('Failed to get services.');\n    return;\n  }\n\n  print('Found ${services.length} services:');\n  for (final service in services) {\n    print(' $service');\n  }\n}\n\nvoid startService(String serviceName) {\n  print(switch (ServiceManager.start(serviceName)) {\n    ServiceStartResult.success =>\n      'Service \"$serviceName\" started successfully.',\n    ServiceStartResult.accessDenied =>\n      'The attempt to start the service \"$serviceName\" was denied due to '\n          'insufficient permissions.',\n    ServiceStartResult.alreadyRunning =>\n      'Service \"$serviceName\" is already running.',\n    ServiceStartResult.failed => 'Failed to start service \"$serviceName\".',\n    ServiceStartResult.timedOut =>\n      'The attempt to start service \"$serviceName\" timed out.'\n  });\n}\n\nvoid status(String serviceName) {\n  final status = ServiceManager.status(serviceName);\n  if (status == null) {\n    print('Failed to get status of service \"$serviceName\".');\n  } else {\n    print('Status of service \"$serviceName\": ${status.name}');\n  }\n}\n\nvoid stopService(String serviceName) {\n  print(switch (ServiceManager.stop(serviceName)) {\n    ServiceStopResult.success => 'Service \"$serviceName\" stopped successfully.',\n    ServiceStopResult.accessDenied =>\n      'The attempt to stop the service \"$serviceName\" was denied due to '\n          'insufficient permissions.',\n    ServiceStopResult.alreadyStopped =>\n      'Service \"$serviceName\" is already stopped.',\n    ServiceStopResult.failed => 'Failed to stop service \"$serviceName\".',\n    ServiceStopResult.timedOut =>\n      'The attempt to stop service \"$serviceName\" timed out.'\n  });\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Finally, update the ",(0,s.jsx)(n.strong,{children:"pubspec.yaml"})," file to include the ",(0,s.jsx)(n.code,{children:"executables"})," section\nand specify the entry point for the CLI:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="pubspec.yaml"',children:"name: service_manager_cli\ndescription: Service Manager CLI\npublish_to: none\n\nenvironment:\n  sdk: ^3.8.0\n\ndependencies:\n  ffi: ^2.1.4\n  win32: ^5.13.0\n\ndev_dependencies:\n  halildurmus_lints: ^1.0.1\n\n// highlight-start\nexecutables:\n  service_manager_cli:\n// highlight-end\n"})}),"\n",(0,s.jsx)(n.p,{children:"You now have a powerful CLI tool for efficiently managing Windows services.\nTo use it, run the following command in your terminal:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cmd",metastring:'title="Terminal"',children:"dart run service_manager_cli\n"})}),"\n",(0,s.jsx)(n.p,{children:"This command provides information about available commands, global options, and\nusage:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"A command-line interface for managing Windows services.\n\nUsage: service_manager_cli <command> [arguments]\n\nGlobal options:\n  -v, --verbose         Show additional command output.\n  -h, --help            Print this usage information.\nq\nAvailable commands:\n  list                  List all services.\n  start <service_name>  Start a service.\n  status <service_name> Get the status of a service.\n  stop <service_name>   Stop a service.\n"})}),"\n",(0,s.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsxs)(n.p,{children:["In this blog post, we've explored how to build a command-line interface (CLI) in\nDart using the ",(0,s.jsx)(n.strong,{children:"win32"})," package to manage Windows services. From listing and\ncontrolling services to checking their status, we've covered essential tasks\nthat streamline Windows service administration directly from your command line."]}),"\n",(0,s.jsx)(n.p,{children:"I hope you found this tutorial helpful! If you have any questions or feedback,\nplease feel free to reach out. Happy coding! \uD83D\uDE80"}),"\n",(0,s.jsx)(n.h2,{id:"source-code",children:"Source Code"}),"\n",(0,s.jsx)(t,{href:"https://github.com/halildurmus/win32/tree/main/examples/service_manager_cli"})]})}function u(e={}){let{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},7151:function(e){e.exports=JSON.parse('{"permalink":"/blog/building-service-manager-cli","source":"@site/blog/2024/07-13-building-service-manager-cli/index.mdx","title":"Building a Service Manager CLI in Dart with win32","description":"We\'ll build a command-line interface (CLI) to manage Windows services in Dart using the win32 package.","date":"2024-07-13T00:00:00.000Z","tags":[{"inline":true,"label":"win32","permalink":"/blog/tags/win-32"},{"inline":true,"label":"dart","permalink":"/blog/tags/dart"},{"inline":true,"label":"tutorial","permalink":"/blog/tags/tutorial"},{"inline":true,"label":"cli","permalink":"/blog/tags/cli"}],"readingTime":18.155,"hasTruncateMarker":true,"authors":[{"name":"Halil Durmus","title":"Software Engineer / Maintainer of win32","url":"https://halildurmus.dev","page":{"permalink":"/blog/authors/halildurmus"},"socials":{"github":"https://github.com/halildurmus"},"github":"https://github.com/halildurmus","imageURL":"https://github.com/halildurmus.png","key":"halildurmus"}],"frontMatter":{"title":"Building a Service Manager CLI in Dart with win32","description":"We\'ll build a command-line interface (CLI) to manage Windows services in Dart using the win32 package.","slug":"building-service-manager-cli","authors":"halildurmus","tags":["win32","dart","tutorial","cli"],"image":"https://ik.imagekit.io/npajaqrcn/blog/2024-07-13-building-service-manager-cli/social.png","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Building a Task Manager App in Flutter with win32","permalink":"/blog/building-task-manager-app"},"nextItem":{"title":"Calling Windows APIs in Dart with win32","permalink":"/blog/calling-windows-apis"}}')}}]);