"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["4108"],{47677(e,t,n){n.r(t),n.d(t,{metadata:()=>s,default:()=>u,frontMatter:()=>a,contentTitle:()=>l,toc:()=>o,assets:()=>c});var s=JSON.parse('{"id":"core/structs","title":"Structs","description":"Win32 APIs frequently use C structs to pass data between functions. In Dart","source":"@site/docs/core/structs.md","sourceDirName":"core","slug":"/core/structs","permalink":"/docs/core/structs","draft":false,"unlisted":false,"editUrl":"https://github.com/halildurmus/win32/tree/main/website/docs/core/structs.md","tags":[],"version":"current","lastUpdatedBy":"Halil Durmus","lastUpdatedAt":1772220481000,"frontMatter":{"title":"Structs"},"sidebar":"mainSidebar","previous":{"title":"Strings","permalink":"/docs/core/strings"},"next":{"title":"Callbacks","permalink":"/docs/advanced/callbacks"}}'),i=n(74848),r=n(28453);let a={title:"Structs"},l,c={},o=[{value:"Allocating Structs",id:"allocating-structs",level:2},{value:"Accessing Struct Fields",id:"accessing-struct-fields",level:2},{value:"Initializing Size Fields",id:"initializing-size-fields",level:2},{value:"Common Struct Usage Patterns",id:"common-struct-usage-patterns",level:2},{value:"Output-only Structs",id:"output-only-structs",level:3},{value:"Input-only Structs",id:"input-only-structs",level:3},{value:"Input/Output Structs",id:"inputoutput-structs",level:3}];function d(e){let t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{CommonViewSourceCode:n}=t;return n||function(e,t){throw Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("CommonViewSourceCode",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["Win32 APIs frequently use ",(0,i.jsx)(t.strong,{children:"C structs"})," to pass data between functions. In Dart\nFFI, these are represented as subclasses of ",(0,i.jsx)(t.a,{href:"https://api.dart.dev/dart-ffi/Struct-class.html",children:(0,i.jsx)(t.code,{children:"Struct"})})," and can live in\neither ",(0,i.jsx)(t.strong,{children:"Dart memory"})," or ",(0,i.jsx)(t.strong,{children:"native memory"}),". However, most Win32 APIs expect\nstructs to be allocated in native memory."]}),"\n",(0,i.jsx)(t.h2,{id:"allocating-structs",children:"Allocating Structs"}),"\n",(0,i.jsxs)(t.p,{children:["All Win32 structs must be allocated in ",(0,i.jsx)(t.strong,{children:"native memory"})," before being passed to\nan API."]}),"\n",(0,i.jsxs)(t.p,{children:["The simplest and safest way is to use an ",(0,i.jsx)(t.a,{href:"https://pub.dev/documentation/ffi/latest/ffi/Arena-class.html",children:(0,i.jsx)(t.code,{children:"Arena"})}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",children:"using((arena) {\n  // highlight-next-line\n  final status = arena<SYSTEM_POWER_STATUS>();\n});\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This allocates ",(0,i.jsx)(t.strong,{children:"zero-initialized"})," native memory for the struct.\nThe memory is automatically freed when the ",(0,i.jsx)(t.a,{href:"https://pub.dev/documentation/ffi/latest/ffi/using.html",children:(0,i.jsx)(t.code,{children:"using()"})})," scope exits."]}),"\n",(0,i.jsx)(t.p,{children:"This is equivalent to:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",children:"final status = adaptiveCalloc<SYSTEM_POWER_STATUS>();\nfree(status);\n"})}),"\n",(0,i.jsx)(t.p,{children:"...but without requiring manual cleanup."}),"\n",(0,i.jsx)(t.h2,{id:"accessing-struct-fields",children:"Accessing Struct Fields"}),"\n",(0,i.jsxs)(t.p,{children:["Struct fields are accessed by dereferencing the pointer using\n",(0,i.jsx)(t.a,{href:"https://api.dart.dev/dart-ffi/StructPointer/ref.html",children:(0,i.jsx)(t.code,{children:"StructPointer.ref"})}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",children:"final batteryFlag = status.ref.BatteryFlag;\nfinal lifePercent = status.ref.BatteryLifePercent;\n"})}),"\n",(0,i.jsx)(t.p,{children:"You can also destructure the struct for clarity:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",children:"final SYSTEM_POWER_STATUS(:BatteryFlag, :BatteryLifePercent) = status.ref;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This avoids repetitive ",(0,i.jsx)(t.code,{children:"status.ref.field"})," access and makes it obvious which\nfields are being used."]}),"\n",(0,i.jsx)(t.h2,{id:"initializing-size-fields",children:"Initializing Size Fields"}),"\n",(0,i.jsxs)(t.p,{children:["Some Win32 structs include a size field (typically named ",(0,i.jsx)(t.code,{children:"cbSize"}),").\nThis is used to disambiguate struct variants or versions."]}),"\n",(0,i.jsxs)(t.p,{children:["For example, ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/windows/win32/api/winuser/ns-winuser-wndclassexw",children:(0,i.jsx)(t.code,{children:"WNDCLASSEX"})})," must have ",(0,i.jsx)(t.code,{children:"cbSize"})," initialized:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",children:"using((arena) {\n  // highlight-next-line\n  final wc = arena<WNDCLASSEX>()..ref.cbSize = sizeOf<WNDCLASSEX>();\n  RegisterClassEx(wc);\n});\n"})}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsxs)(t.p,{children:["If a struct has a ",(0,i.jsx)(t.code,{children:"cbSize"})," (or similar) field, you must initialize it before\npassing the struct to any Win32 API. Failure to do this is a common source of\nsubtle bugs."]})}),"\n",(0,i.jsx)(t.h2,{id:"common-struct-usage-patterns",children:"Common Struct Usage Patterns"}),"\n",(0,i.jsx)(t.p,{children:"Win32 APIs use structs in three distinct ways."}),"\n",(0,i.jsx)(t.h3,{id:"output-only-structs",children:"Output-only Structs"}),"\n",(0,i.jsx)(t.p,{children:"The API fills the struct with data."}),"\n",(0,i.jsxs)(t.p,{children:["As an example, consider ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/windows/win32/api/winbase/nf-winbase-getsystempowerstatus",children:(0,i.jsx)(t.code,{children:"GetSystemPowerStatus"})}),", which\nretrieves the current power state of the system."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",metastring:'title="sysinfo.dart"',children:"void main() {\n  using((arena) {\n    // highlight-next-line\n    final lpSystemPowerStatus = adaptiveCalloc<SYSTEM_POWER_STATUS>();\n\n    final Win32Result(:value, :error) = GetSystemPowerStatus(\n      lpSystemPowerStatus,\n    );\n    if (!value) throw WindowsException(error.toHRESULT());\n\n    // highlight-start\n    final SYSTEM_POWER_STATUS(:BatteryFlag, :BatteryLifePercent) =\n        lpSystemPowerStatus.ref;\n    // highlight-end\n\n    if (BatteryFlag >= 128) {\n      // This value is only less than 128 if a battery is detected.\n      print('No system battery detected.');\n    } else {\n      if (BatteryLifePercent <= 100) {\n        print('Battery detected with $BatteryLifePercent% remaining.');\n      } else {\n        // Windows sets this value to 255 if it can't detect remaining life.\n        print('Battery detected but status unknown.');\n      }\n    }\n  });\n}\n"})}),"\n",(0,i.jsx)(n,{href:"https://github.com/halildurmus/win32/blob/main/examples/sysinfo.dart"}),"\n",(0,i.jsx)(t.p,{children:"Here:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"The struct is allocated by the caller"}),"\n",(0,i.jsx)(t.li,{children:"The API writes into it"}),"\n",(0,i.jsx)(t.li,{children:"The fields are read afterward"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"input-only-structs",children:"Input-only Structs"}),"\n",(0,i.jsx)(t.p,{children:"You populate the struct before passing it to the API."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",children:"using((arena) {\n  // highlight-start\n  final point = arena<POINT>();\n  point.ref\n    ..x = 10\n    ..y = 20;\n  // highlight-end\n  ClientToScreen(hwnd, point);\n});\n"})}),"\n",(0,i.jsx)(t.h3,{id:"inputoutput-structs",children:"Input/Output Structs"}),"\n",(0,i.jsx)(t.p,{children:"You initialize some fields, and the API may overwrite fields:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-dart",children:"using((arena) {\n  // highlight-start\n  final rect = arena<RECT>();\n  rect.ref\n    ..left = 0\n    ..top = 0\n    ..right = 800\n    ..bottom = 600;\n  // highlight-end\n  AdjustWindowRect(rect, WS_OVERLAPPEDWINDOW, false);\n  final RECT(:left, :top, :right, :bottom) = rect.ref;\n});\n"})})]})}function u(e={}){let{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453(e,t,n){n.d(t,{R:()=>a,x:()=>l});var s=n(96540);let i={},r=s.createContext(i);function a(e){let t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);