name: Release

on:
  push:
    branches: [main]
    paths:
      - packages/*/CHANGELOG.md
      - packages/*/pubspec.yaml
  workflow_dispatch:
    inputs:
      package:
        required: true
        description: Package to release
        type: choice
        options:
          - ffi_leak_tracker
          - win32
          - win32_registry
          - win32_runner

jobs:
  check-release:
    if: ${{ github.event_name != 'workflow_dispatch' }}

    runs-on: ubuntu-latest

    outputs:
      package: ${{ steps.check_release.outputs.package }}
      should_publish: ${{ steps.check_release.outputs.should_publish }}

    steps:
      - name: ðŸ“š Git Checkout
        uses: actions/checkout@v6

      - name: ðŸ” Check if There is a Release Commit
        id: check_release
        run: |
          msg=$(git log -1 --pretty=format:%s)
          echo "ðŸ“œ Latest commit: $msg"

          if [[ "$msg" =~ chore\(release\):[[:space:]]+.*package:([a-zA-Z0-9_]+).*v ]]; then
            pkg="${BASH_REMATCH[1]}"
            echo "ðŸŽ¯ Package: $pkg"
            echo "package=$pkg" >> $GITHUB_OUTPUT
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Not a release commit"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

  release:
    needs: [check-release]
    if: ${{ github.event_name == 'workflow_dispatch' || needs.check-release.outputs.should_publish == 'true' }}
    uses: halildurmus/workflows/.github/workflows/dart_release.yml@main
    with:
      working_directory: packages/${{ github.event_name == 'workflow_dispatch' && inputs.package || needs.check-release.outputs.package }}
    secrets:
      token: ${{ secrets.PAT }}
