name: Publish

on:
  push:
    branches: [main]
    paths:
      - packages/win32/CHANGELOG.md
      - packages/win32/pubspec.yaml

jobs:
  check-release:
    runs-on: ubuntu-latest

    outputs:
      should_publish: ${{ steps.check_release.outputs.should_publish }}

    steps:
      - name: ðŸ“š Git Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Check if There is a Release Commit
        id: check_release
        run: |
          # Get the latest commit message
          latest_commit_msg=$(git log -1 --pretty=%B)

          # Output the latest commit message
          echo "Latest commit message: $latest_commit_msg"

          # Check if the commit message matches the release pattern
          if [[ "$latest_commit_msg" =~ ^chore\(release\):\ v.* ]]; then
            echo "Release commit found."
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "No release commit found."
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

  publish:
    needs: check-release
    if: needs.check-release.outputs.should_publish == 'true'
    uses: halildurmus/workflows/.github/workflows/dart_pub_publish.yml@main
    with:
      working_directory: packages/win32
    secrets:
      token: ${{ secrets.PAT }}
